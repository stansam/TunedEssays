{% extends "admin/base.html" %}

{% block title %}Create Sample - Admin{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.12.0/tagify.min.css" rel="stylesheet">
<style>
    .create-sample-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: calc(100vh - 60px);
        padding: 2rem 0;
    }
    .tagify {
        border: 1px solid var(--gray-light);
        border-radius: 5px;
        padding: 5px;
    }
    .sample-form-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
        margin-bottom: 2rem;
    }

    .sample-form-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--secondary));
    }

    .form-header {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        padding: 2rem;
        border-bottom: 1px solid #e9ecef;
        position: relative;
        overflow: hidden;
    }

    .form-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: 50%;
        opacity: 0.1;
    }

    .form-header h1 {
        color: var(--dark);
        font-weight: 700;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .form-header .subtitle {
        color: var(--gray);
        font-size: 1.1rem;
        position: relative;
        z-index: 2;
    }

    .form-section {
        margin-bottom: 2rem;
        opacity: 0;
        transform: translateY(20px);
        animation: slideInUp 0.6s ease forwards;
    }

    .form-section:nth-child(2) { animation-delay: 0.1s; }
    .form-section:nth-child(3) { animation-delay: 0.2s; }
    .form-section:nth-child(4) { animation-delay: 0.3s; }
    .form-section:nth-child(5) { animation-delay: 0.4s; }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }

    .enhanced-input {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .enhanced-input label {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .enhanced-input input,
    .enhanced-input select,
    .enhanced-input textarea {
        width: 100%;
        padding: 1rem 1.5rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fff;
    }

    .enhanced-input input:focus,
    .enhanced-input select:focus,
    .enhanced-input textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
        transform: translateY(-2px);
    }

    .enhanced-input .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
        font-size: 1.1rem;
        pointer-events: none;
    }

    .character-counter {
        position: absolute;
        bottom: -1.5rem;
        right: 0;
        font-size: 0.85rem;
        color: var(--gray);
    }

    .character-counter.warning {
        color: var(--warning);
    }

    .character-counter.danger {
        color: var(--danger);
    }

    .word-count-display {
        background: linear-gradient(135deg, var(--primary-subtle), rgba(76, 175, 80, 0.05));
        border: 2px solid var(--primary-subtle);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .word-count-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        display: block;
    }

    .word-count-label {
        color: var(--gray);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .featured-toggle {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .featured-toggle:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.1);
    }

    .featured-toggle.active {
        background: linear-gradient(135deg, var(--primary-subtle), rgba(76, 175, 80, 0.05));
        border-color: var(--primary);
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: #ddd;
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .toggle-switch.active {
        background: var(--primary);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::after {
        transform: translateX(30px);
    }

    .image-upload-area {
        border: 3px dashed #e9ecef;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
        position: relative;
        overflow: hidden;
    }

    .image-upload-area:hover {
        border-color: var(--primary);
        background: var(--primary-subtle);
    }

    .image-upload-area.dragover {
        border-color: var(--primary);
        background: var(--primary-subtle);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--gray);
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .image-upload-area:hover .upload-icon {
        color: var(--primary);
        transform: scale(1.1);
    }

    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin: 1rem auto;
        display: none;
    }

    .quill-container {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .quill-container:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
    }

    .ql-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .ql-editor {
        min-height: 300px;
        font-size: 1rem;
        line-height: 1.6;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 2rem;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-primary:hover::before {
        left: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
    }

    .form-progress {
        position: sticky;
        top: 0;
        z-index: 99;
        background: white;
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }

    .progress-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        width: 0;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--gray);
    }

    .select2-container--default .select2-selection--single {
        height: 50px;
        padding: 0.5rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
    }

    .select2-container--default .select2-selection--single:focus {
        border-color: var(--primary);
    }

    .floating-help {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .floating-help:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
    }

    .help-tooltip {
        position: absolute;
        bottom: 70px;
        right: 0;
        background: var(--dark);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        transform: translateY(10px);
    }

    .help-tooltip.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .help-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        right: 20px;
        border: 8px solid transparent;
        border-top-color: var(--dark);
    }

    @keyframes slideInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @media (max-width: 768px) {
        .create-sample-container {
            padding: 1rem 0;
        }
        
        .form-header {
            padding: 1.5rem;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .floating-help {
            bottom: 1rem;
            right: 1rem;
        }
    }
</style>
<style>
    .preview-modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    overflow: hidden;
}

.preview-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #e9ecef;
    padding: 1.5rem 2rem;
    position: relative;
}

.preview-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary, #4CAF50), var(--primary-light, #66BB6A), var(--secondary, #2196F3));
}

.preview-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.preview-header .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark, #333);
    margin: 0;
}

.preview-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.preview-status {
    background: #6c757d;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.preview-status.draft {
    background: #ffc107;
    color: #000;
}

.preview-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.preview-close:hover {
    opacity: 1;
}

.preview-body {
    padding: 0;
    max-height: 70vh;
    overflow-y: auto;
}

.preview-container {
    padding: 2rem;
}

.preview-sample-header {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #f1f3f4;
}

.preview-sample-image {
    flex-shrink: 0;
    width: 200px;
    height: 150px;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
}

.preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
}

.preview-no-image {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    font-size: 0.9rem;
}

.preview-no-image i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.preview-sample-info {
    flex: 1;
}

.preview-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark, #333);
    margin-bottom: 1rem;
    line-height: 1.3;
}

.preview-badges {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.preview-service-badge {
    background: linear-gradient(135deg, var(--primary, #4CAF50), var(--primary-light, #66BB6A));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.preview-featured-badge {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #8b5a00;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.preview-stats {
    display: flex;
    gap: 2rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.stat-item i {
    font-size: 1rem;
}

.preview-excerpt-section,
.preview-content-section {
    margin-bottom: 2rem;
}

.preview-section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--dark, #333);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f1f3f4;
}

.preview-excerpt {
    background: #f8f9fa;
    border-left: 4px solid var(--primary, #4CAF50);
    padding: 1.5rem;
    border-radius: 0 12px 12px 0;
    font-style: italic;
    color: #495057;
    line-height: 1.6;
}

.preview-content {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 2rem;
    min-height: 200px;
    line-height: 1.7;
    color: #333;
}

.preview-content h1,
.preview-content h2,
.preview-content h3,
.preview-content h4,
.preview-content h5,
.preview-content h6 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.preview-content h1 { font-size: 2rem; }
.preview-content h2 { font-size: 1.75rem; }
.preview-content h3 { font-size: 1.5rem; }

.preview-content p {
    margin-bottom: 1rem;
}

.preview-content ul,
.preview-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.preview-content li {
    margin-bottom: 0.5rem;
}

.preview-content blockquote {
    border-left: 4px solid var(--primary, #4CAF50);
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
}

.preview-content code {
    background: #f1f3f4;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.preview-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.preview-footer {
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    padding: 1.5rem 2rem;
}

.preview-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    width: 100%;
}

.preview-trigger-btn {
    background: linear-gradient(135deg, #17a2b8, #20c997);
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.preview-trigger-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.preview-trigger-btn:hover::before {
    left: 100%;
}

.preview-trigger-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .preview-sample-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .preview-sample-image {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
    }
    
    .preview-title {
        font-size: 1.5rem;
    }
    
    .preview-stats {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .preview-actions {
        flex-direction: column;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
}

/* Animation for modal entrance */
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal.show .modal-dialog {
    animation: modalSlideIn 0.3s ease-out;
}

/* Loading state for preview button */
.preview-trigger-btn.loading {
    pointer-events: none;
    opacity: 0.7;
}

.preview-trigger-btn.loading i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="create-sample-container">
    <!-- Form Progress -->
    <div class="form-progress">
        <div class="container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Form Completion: 0%</div>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="sample-form-card">
                    <!-- Form Header -->
                    <div class="form-header">
                        <h1><i class="fas fa-file-signature me-3"></i>Create New Sample</h1>
                        <p class="subtitle">Craft engaging academic samples to showcase your expertise</p>
                    </div>

                    <!-- Form Content -->
                    <form id="sampleForm" method="POST" enctype="multipart/form-data" class="p-4">
                        <input type="hidden" name="csrf-token" value="{{ csrf_token() }}">
                        
                        
                        <div class="form-section">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                Basic Information
                            </h3>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="enhanced-input">
                                        <label for="title">
                                            <i class="fas fa-heading text-primary"></i>
                                            Sample Title *
                                        </label>
                                        <input type="text" id="title" name="title" required 
                                               placeholder="Enter a compelling title for your sample">
                                        <div class="character-counter" id="titleCounter">0/200</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="enhanced-input">
                                        <label for="service_id">
                                            <i class="fas fa-tags text-primary"></i>
                                            Service Category *
                                        </label>
                                        <select id="service_id" name="service_id" required>
                                            <option value="">Select a service...</option>
                                            <!-- Services will be populated via JavaScript -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="enhanced-input">
                                <label for="excerpt">
                                    <i class="fas fa-quote-left text-primary"></i>
                                    Sample Excerpt
                                </label>
                                <textarea id="excerpt" name="excerpt" rows="4" 
                                          placeholder="Write a brief, engaging excerpt that summarizes your sample..."></textarea>
                                <div class="character-counter" id="excerptCounter">0/500</div>
                            </div>
                        </div>

                        <!-- Content Section -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                Sample Content
                            </h3>

                            <div class="word-count-display">
                                <span class="word-count-number" id="wordCount">0</span>
                                <span class="word-count-label">Words</span>
                            </div>

                            <div class="quill-container">
                                <div id="contentEditor"></div>
                            </div>
                            <input type="hidden" id="content" name="content">
                        </div>
                        <div class="form-section mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            <input type="text" id="tags" name="tags" class="form-control" placeholder="Add relevant tags">
                            <small class="text-muted">Hit Enter after each tag. Recommended: 3-5 tags</small>
                        </div>
                        <!-- Settings Section -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                Sample Settings
                            </h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="enhanced-input">
                                        <label>
                                            <i class="fas fa-star text-warning"></i>
                                            Featured Sample
                                        </label>
                                        <div class="featured-toggle" id="featuredToggle">
                                            <div>
                                                <strong>Feature this sample</strong>
                                                <p class="mb-0 text-muted small">Featured samples appear prominently on your site</p>
                                            </div>
                                            <div class="toggle-switch" id="toggleSwitch"></div>
                                            <input type="hidden" id="featured" name="featured" value="0">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="enhanced-input">
                                        <label for="word_count_manual">
                                            <i class="fas fa-calculator text-primary"></i>
                                            Manual Word Count (Optional)
                                        </label>
                                        <input type="number" id="word_count_manual" name="word_count" min="0" 
                                               placeholder="Leave blank for auto-calculation">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                Sample Image
                            </h3>

                            <div class="image-upload-area" id="imageUploadArea">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h4>Upload Sample Image</h4>
                                <p class="text-muted">Drag and drop an image here, or click to browse</p>
                                <small class="text-muted">Supported formats: JPG, PNG, GIF (Max: 5MB)</small>
                                <input type="file" id="image" name="image" accept="image/*" style="display: none;">
                                <img id="imagePreview" class="image-preview" alt="Image preview">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </button>
                            <!-- <button type="button" class="btn btn-info preview-trigger-btn">
                                <i class="fas fa-eye me-2"></i>Preview Sample
                            </button> -->
                            <button type="submit" class="btn btn-primary pulse-animation">
                                <i class="fas fa-save me-2"></i>Create Sample
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Help Button -->
<div class="floating-help" id="floatingHelp">
    <i class="fas fa-question"></i>
    <div class="help-tooltip" id="helpTooltip">
        Need help? Click for quick tips!
    </div>
</div>

<!-- HTML: Preview Modal Structure -->
<div class="modal fade" id="samplePreviewModal" tabindex="-1" aria-labelledby="samplePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content preview-modal-content">
            <div class="modal-header preview-header">
                <div class="preview-header-content">
                    <h5 class="modal-title" id="samplePreviewModalLabel">
                        <i class="fas fa-eye me-2"></i>Sample Preview
                    </h5>
                    <div class="preview-meta">
                        <span class="preview-status draft">
                            <i class="fas fa-file-alt me-1"></i>Draft
                        </span>
                    </div>
                </div>
                <button type="button" class="btn-close preview-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body preview-body">
                <div class="preview-container">
                    <!-- Sample Header -->
                    <div class="preview-sample-header">
                        <div class="preview-sample-image">
                            <img id="previewImage" src="" alt="Sample Image" class="preview-img">
                            <div class="preview-no-image">
                                <i class="fas fa-image"></i>
                                <span>No Image</span>
                            </div>
                        </div>
                        <div class="preview-sample-info">
                            <h1 class="preview-title" id="previewTitle">Sample Title</h1>
                            <div class="preview-badges">
                                <span class="preview-service-badge" id="previewService">Service Category</span>
                                <span class="preview-featured-badge" id="previewFeatured" style="display: none;">
                                    <i class="fas fa-star me-1"></i>Featured
                                </span>
                            </div>
                            <div class="preview-stats">
                                <div class="stat-item">
                                    <i class="fas fa-font text-primary"></i>
                                    <span id="previewWordCount">0</span> words
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-calendar text-primary"></i>
                                    <span id="previewDate">Today</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Excerpt -->
                    <div class="preview-excerpt-section">
                        <h6 class="preview-section-title">
                            <i class="fas fa-quote-left me-2"></i>Excerpt
                        </h6>
                        <div class="preview-excerpt" id="previewExcerpt">
                            No excerpt provided.
                        </div>
                    </div>

                    <!-- Sample Content -->
                    <div class="preview-content-section">
                        <h6 class="preview-section-title">
                            <i class="fas fa-file-text me-2"></i>Content
                        </h6>
                        <div class="preview-content" id="previewContent">
                            No content provided.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer preview-footer">
                <div class="preview-actions">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-edit me-2"></i>Continue Editing
                    </button>
                    <button type="button" class="btn btn-primary" id="previewSaveBtn">
                        <i class="fas fa-save me-2"></i>Save Sample
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.12.0/tagify.min.js"></script>



<script>
class SampleFormManager {
    constructor() {
        this.quill = null;
        this.form = document.getElementById('sampleForm');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.wordCount = document.getElementById('wordCount');
        this.featuredToggle = false;
        
        this.init();
    }
    
    init() {
        this.initQuillEditor();
        this.initSelect2();
        this.initEventListeners();
        this.initImageUpload();
        this.loadServices();
        this.updateProgress();
    }
    
    initQuillEditor() {
        this.quill = new Quill('#contentEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Write your sample content here... Be detailed and showcase your expertise!'
        });
        
        // Update word count and progress as user types
        this.quill.on('text-change', () => {
            this.updateWordCount();
            this.updateProgress();
            this.syncContent();
        });
    }
    
    initSelect2() {
        $('#service_id').select2({
            placeholder: 'Select a service category...',
            allowClear: true,
            width: '100%'
        });
        
        $('#service_id').on('change', () => {
            this.updateProgress();
        });
    }
    
    initEventListeners() {
        // Title character counter
        const titleInput = document.getElementById('title');
        const titleCounter = document.getElementById('titleCounter');
        const tagInput = document.querySelector('#tags');
        new Tagify(tagInput);

        titleInput.addEventListener('input', (e) => {
            const length = e.target.value.length;
            const maxLength = 200;
            titleCounter.textContent = `${length}/${maxLength}`;
            
            if (length > maxLength * 0.8) {
                titleCounter.classList.add('warning');
            } else {
                titleCounter.classList.remove('warning');
            }
            
            if (length >= maxLength) {
                titleCounter.classList.add('danger');
                e.target.value = e.target.value.substring(0, maxLength);
            } else {
                titleCounter.classList.remove('danger');
            }
            
            this.updateProgress();
        });
        
        // Excerpt character counter
        const excerptInput = document.getElementById('excerpt');
        const excerptCounter = document.getElementById('excerptCounter');
        
        excerptInput.addEventListener('input', (e) => {
            const length = e.target.value.length;
            const maxLength = 500;
            excerptCounter.textContent = `${length}/${maxLength}`;
            
            if (length > maxLength * 0.8) {
                excerptCounter.classList.add('warning');
            } else {
                excerptCounter.classList.remove('warning');
            }
            
            if (length >= maxLength) {
                excerptCounter.classList.add('danger');
                e.target.value = e.target.value.substring(0, maxLength);
            } else {
                excerptCounter.classList.remove('danger');
            }
            
            this.updateProgress();
        });
        
        // Featured toggle
        const featuredToggleEl = document.getElementById('featuredToggle');
        const toggleSwitch = document.getElementById('toggleSwitch');
        const featuredInput = document.getElementById('featured');
        
        featuredToggleEl.addEventListener('click', () => {
            this.featuredToggle = !this.featuredToggle;
            
            if (this.featuredToggle) {
                featuredToggleEl.classList.add('active');
                toggleSwitch.classList.add('active');
                featuredInput.value = '1';
            } else {
                featuredToggleEl.classList.remove('active');
                toggleSwitch.classList.remove('active');
                featuredInput.value = '0';
            }
            
            this.updateProgress();
        });
        
        // Form submission
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit();
        });
        
        // Floating help
        const floatingHelp = document.getElementById('floatingHelp');
        const helpTooltip = document.getElementById('helpTooltip');
        
        floatingHelp.addEventListener('click', () => {
            this.showHelpModal();
        });
        
        floatingHelp.addEventListener('mouseenter', () => {
            helpTooltip.classList.add('show');
        });
        
        floatingHelp.addEventListener('mouseleave', () => {
            helpTooltip.classList.remove('show');
        });
    }
    
    initImageUpload() {
        const uploadArea = document.getElementById('imageUploadArea');
        const fileInput = document.getElementById('image');
        const imagePreview = document.getElementById('imagePreview');
        
        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                this.handleImageUpload(e.target.files[0]);
            }
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                this.handleImageUpload(e.dataTransfer.files[0]);
            }
        });
    }
    
    handleImageUpload(file) {
        // Validate file
        if (!file.type.startsWith('image/')) {
            this.showToast('Please select a valid image file.', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB
            this.showToast('Image size must be less than 5MB.', 'error');
            return;
        }
        
        // Preview image
        const reader = new FileReader();
        reader.onload = (e) => {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            
            // Update upload area
            const uploadArea = document.getElementById('imageUploadArea');
            uploadArea.querySelector('h4').textContent = 'Image Selected';
            uploadArea.querySelector('p').textContent = file.name;
        };
        reader.readAsDataURL(file);
        
        this.updateProgress();
    }
    
    updateWordCount() {
        const text = this.quill.getText();
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        this.wordCount.textContent = words.toLocaleString();
        
        // Update hidden input if manual word count is not set
        const manualWordCount = document.getElementById('word_count_manual');
        if (!manualWordCount.value) {
            manualWordCount.setAttribute('data-auto-count', words);
        }
    }
    
    syncContent() {
        const contentInput = document.getElementById('content');
        contentInput.value = this.quill.root.innerHTML;
    }
    
    updateProgress() {
        let completedFields = 0;
        const totalFields = 5; // title, service, content, excerpt, image (optional but counts)
        
        // Check title
        const title = document.getElementById('title').value.trim();
        if (title.length > 0) completedFields++;
        
        // Check service selection
        const serviceId = document.getElementById('service_id').value;
        if (serviceId) completedFields++;
        
        // Check content
        const content = this.quill.getText().trim();
        if (content.length > 50) completedFields++; // Require substantial content
        
        // Check excerpt
        const excerpt = document.getElementById('excerpt').value.trim();
        if (excerpt.length > 0) completedFields++;
        
        // Check image (optional but adds to progress)
        const imageInput = document.getElementById('image');
        if (imageInput.files && imageInput.files.length > 0) completedFields++;
        
        const progress = Math.round((completedFields / totalFields) * 100);
        this.progressFill.style.width = `${progress}%`;
        this.progressText.textContent = `Form Completion: ${progress}%`;
    }
    
    async loadServices() {
        try {
            // This would typically be an API call to fetch services
            // For demo purposes, using static data
            const fallbackServices = [
                { id: 1, name: 'Essay Writing' },
                { id: 2, name: 'Research Papers' },
                { id: 3, name: 'Thesis Writing' },
                { id: 4, name: 'Dissertation' },
                { id: 5, name: 'Case Studies' },
                { id: 6, name: 'Lab Reports' },
                { id: 7, name: 'Book Reviews' },
                { id: 8, name: 'Literature Review' }
            ];
            let services = fallbackServices;
             try {
                const response = await fetch('/api/services')
                if(response.ok){
                    const data = await response.json();
                    if(data && data.length > 0 ) {
                        services = data;
                    }
                }
            } catch (fetchError) {
                console.warn("Failed to fetch data from api, using fallback data:", fetchError);
            }
            this.populateServiceSelect(services);
        } catch (error) {
            console.error('Failed to load services:', error)
            this.showToast('Failed to load service categories.', 'error');
        }
    }
        populateServiceSelect(services) {
            const serviceSelect = document.getElementById('service_id');
            while (serviceSelect.children.length > 1) {
                serviceSelect.removeChild(serviceSelect.lastChild);
            }
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.name;
                serviceSelect.appendChild(option);
            });
            
            // Refresh Select2 to show new options
            $('#service_id').trigger('change');
            
        } 
    
    
    validateForm() {
        const errors = [];
        
        // Validate title
        const title = document.getElementById('title').value.trim();
        if (!title) {
            errors.push('Title is required.');
        } else if (title.length < 10) {
            errors.push('Title must be at least 10 characters long.');
        }
        
        // Validate service selection
        const serviceId = document.getElementById('service_id').value;
        if (!serviceId) {
            errors.push('Please select a service category.');
        }
        
        // Validate content
        const content = this.quill.getText().trim();
        if (!content || content.length < 100) {
            errors.push('Content must be at least 100 characters long.');
        }
        
        // Validate image if provided
        const imageInput = document.getElementById('image');
        if (imageInput.files && imageInput.files.length > 0) {
            const file = imageInput.files[0];
            if (!file.type.startsWith('image/')) {
                errors.push('Please select a valid image file.');
            }
            if (file.size > 5 * 1024 * 1024) {
                errors.push('Image size must be less than 5MB.');
            }
        }
        
        return errors;
    }
    
    async handleSubmit() {
        // Sync content before validation
        this.syncContent();
        
        // Validate form
        const errors = this.validateForm();
        if (errors.length > 0) {
            this.showToast(errors.join(' '), 'error');
            return;
        }
        
        // Show loading state
        const submitBtn = this.form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Sample...';
        submitBtn.disabled = true;
        
        try {
            // Prepare form data
            const formData = new FormData(this.form);
            
            // Add auto-calculated word count if manual count is not provided
            const manualWordCount = document.getElementById('word_count_manual').value;
            if (!manualWordCount) {
                const autoCount = document.getElementById('word_count_manual').getAttribute('data-auto-count') || '0';
                formData.set('word_count', autoCount);
            }
            
            // Submit form (this would be replaced with actual API endpoint)
            const response = await fetch(this.form.action || '/admin/samples/create', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-Token': document.querySelector('input[name="csrf-token"]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showToast('Sample created successfully!', 'success');
                
                // Redirect after short delay
                setTimeout(() => {
                    window.location.href = result.redirect_url || '/admin/samples';
                }, 1500);
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to create sample.');
            }
            
        } catch (error) {
            console.error('Form submission error:', error);
            this.showToast(error.message || 'An error occurred while creating the sample.', 'error');
        } finally {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    showHelpModal() {
        const helpContent = `
            <div class="help-modal-content">
                <h4><i class="fas fa-lightbulb text-warning me-2"></i>Quick Tips for Creating Great Samples</h4>
                <div class="help-section">
                    <h6><i class="fas fa-heading text-primary me-2"></i>Title</h6>
                    <ul>
                        <li>Make it descriptive and engaging</li>
                        <li>Include the subject or topic area</li>
                        <li>Keep it under 200 characters</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h6><i class="fas fa-edit text-primary me-2"></i>Content</h6>
                    <ul>
                        <li>Showcase your best writing skills</li>
                        <li>Include proper formatting and structure</li>
                        <li>Aim for at least 500 words</li>
                        <li>Use headings, lists, and emphasis appropriately</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h6><i class="fas fa-quote-left text-primary me-2"></i>Excerpt</h6>
                    <ul>
                        <li>Write a compelling summary</li>
                        <li>Highlight key points or findings</li>
                        <li>Make readers want to see more</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h6><i class="fas fa-image text-primary me-2"></i>Image</h6>
                    <ul>
                        <li>Choose relevant, high-quality images</li>
                        <li>Ensure proper licensing for use</li>
                        <li>Keep file size under 5MB</li>
                    </ul>
                </div>
            </div>
        `;
        
        // Create and show modal (you would integrate with your modal system)
        this.showModal('Sample Creation Help', helpContent);
    }
    
    showModal(title, content) {
        // This is a basic modal implementation
        // You would integrate with Bootstrap modal or your preferred modal system
        const modalHtml = `
            <div class="modal fade" id="helpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('helpModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal (assuming Bootstrap is available)
        if (typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
        }
    }
    
    showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas ${this.getToastIcon(type)} me-2"></i>
                <span>${message}</span>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Add toast styles if not already present
        if (!document.querySelector('#toast-styles')) {
            const styles = document.createElement('style');
            styles.id = 'toast-styles';
            styles.textContent = `
                .toast-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 12px;
                    padding: 1rem 1.5rem;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 1rem;
                    min-width: 300px;
                    max-width: 500px;
                    animation: slideInRight 0.3s ease;
                    border-left: 4px solid;
                }
                .toast-success { border-left-color: var(--success, #28a745); }
                .toast-error { border-left-color: var(--danger, #dc3545); }
                .toast-warning { border-left-color: var(--warning, #ffc107); }
                .toast-info { border-left-color: var(--info, #17a2b8); }
                .toast-close {
                    background: none;
                    border: none;
                    font-size: 0.9rem;
                    cursor: pointer;
                    color: var(--gray, #666);
                    padding: 0.25rem;
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(styles);
        }
        
        // Add toast to document
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }
    
    getToastIcon(type) {
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        return icons[type] || icons.info;
    }
}

// Add some additional utility styles for better UX
const additionalStyles = `
    .help-section {
        margin-bottom: 1.5rem;
    }
    .help-section h6 {
        color: var(--dark);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .help-section ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    .help-section li {
        margin-bottom: 0.25rem;
        color: var(--gray);
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;

// Add additional styles to document
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);
</script>


<script>
    // JavaScript: Fixed Preview Modal Functionality
class SamplePreviewManager {
    constructor() {
        this.modal = null;
        this.previewBtn = null;
        this.isPreviewOpen = false;
        this.formManager = null; // Reference to the main form manager
        
        this.init();
    }
    
    init() {
        this.createPreviewButton();
        this.setupEventListeners();
        this.initializeModal();
        this.findFormManager();
    }
    
    findFormManager() {
        // Try to get reference to the main form manager
        // Wait a bit for it to be initialized
        setTimeout(() => {
            if (window.sampleFormManager) {
                this.formManager = window.sampleFormManager;
            }
        }, 200);
    }
    
    createPreviewButton() {
        // Find the action buttons container and add preview button
        const actionButtons = document.querySelector('.action-buttons');
        if (actionButtons) {
            const previewBtn = document.createElement('button');
            previewBtn.type = 'button';
            previewBtn.className = 'btn btn-info preview-trigger-btn';
            previewBtn.id = 'previewSampleBtn';
            previewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Preview Sample';
            
            // Insert before the Create Sample button
            const createBtn = actionButtons.querySelector('.btn-primary');
            if (createBtn) {
                actionButtons.insertBefore(previewBtn, createBtn);
            } else {
                actionButtons.appendChild(previewBtn);
            }
            
            this.previewBtn = previewBtn;
        }
    }
    
    initializeModal() {
        // Add modal HTML to body if it doesn't exist
        if (!document.getElementById('samplePreviewModal')) {
            const modalHTML = `
                <div class="modal fade" id="samplePreviewModal" tabindex="-1" aria-labelledby="samplePreviewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content preview-modal-content">
                            <div class="modal-header preview-header">
                                <div class="preview-header-content">
                                    <h5 class="modal-title" id="samplePreviewModalLabel">
                                        <i class="fas fa-eye me-2"></i>Sample Preview
                                    </h5>
                                    <div class="preview-meta">
                                        <span class="preview-status draft">
                                            <i class="fas fa-file-alt me-1"></i>Draft
                                        </span>
                                    </div>
                                </div>
                                <button type="button" class="btn-close preview-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            
                            <div class="modal-body preview-body">
                                <div class="preview-container">
                                    <!-- Sample Header -->
                                    <div class="preview-sample-header">
                                        <div class="preview-sample-image">
                                            <img id="previewImage" src="" alt="Sample Image" class="preview-img" style="display: none;">
                                            <div class="preview-no-image">
                                                <i class="fas fa-image"></i>
                                                <span>No Image</span>
                                            </div>
                                        </div>
                                        <div class="preview-sample-info">
                                            <h1 class="preview-title" id="previewTitle">Sample Title</h1>
                                            <div class="preview-badges">
                                                <span class="preview-service-badge" id="previewService">Service Category</span>
                                                <span class="preview-featured-badge" id="previewFeatured" style="display: none;">
                                                    <i class="fas fa-star me-1"></i>Featured
                                                </span>
                                            </div>
                                            <div class="preview-stats">
                                                <div class="stat-item">
                                                    <i class="fas fa-font text-primary"></i>
                                                    <span id="previewWordCount">0</span> words
                                                </div>
                                                <div class="stat-item">
                                                    <i class="fas fa-calendar text-primary"></i>
                                                    <span id="previewDate">Today</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sample Excerpt -->
                                    <div class="preview-excerpt-section">
                                        <h6 class="preview-section-title">
                                            <i class="fas fa-quote-left me-2"></i>Excerpt
                                        </h6>
                                        <div class="preview-excerpt" id="previewExcerpt">
                                            No excerpt provided.
                                        </div>
                                    </div>

                                    <!-- Sample Content -->
                                    <div class="preview-content-section">
                                        <h6 class="preview-section-title">
                                            <i class="fas fa-file-text me-2"></i>Content
                                        </h6>
                                        <div class="preview-content" id="previewContent">
                                            No content provided.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer preview-footer">
                                <div class="preview-actions">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-edit me-2"></i>Continue Editing
                                    </button>
                                    <button type="button" class="btn btn-primary" id="previewSaveBtn">
                                        <i class="fas fa-save me-2"></i>Save Sample
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Initialize Bootstrap modal
        this.modal = new bootstrap.Modal(document.getElementById('samplePreviewModal'));
    }
    
    setupEventListeners() {
        // Preview button click
        document.addEventListener('click', (e) => {
            if (e.target.closest('#previewSampleBtn')) {
                e.preventDefault();
                this.showPreview();
            }
        });
        
        // Save from preview
        document.addEventListener('click', (e) => {
            if (e.target.closest('#previewSaveBtn')) {
                e.preventDefault();
                this.saveFromPreview();
            }
        });
        
        // Modal events
        document.addEventListener('shown.bs.modal', (e) => {
            if (e.target.id === 'samplePreviewModal') {
                this.isPreviewOpen = true;
            }
        });
        
        document.addEventListener('hidden.bs.modal', (e) => {
            if (e.target.id === 'samplePreviewModal') {
                this.isPreviewOpen = false;
            }
        });
    }
    
    showPreview() {
        // Show loading state
        if (this.previewBtn) {
            this.previewBtn.classList.add('loading');
            this.previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating Preview...';
        }
        
        try {
            // Collect form data
            const formData = this.collectFormData();
            
            // Debug: Log the collected data
            console.log('Collected form data:', formData);
            
            // Validate essential fields
            if (!this.validateForPreview(formData)) {
                this.restorePreviewButton();
                return;
            }
            
            // Update preview content
            this.updatePreviewContent(formData);
            
            // Show modal
            this.modal.show();
            
        } catch (error) {
            console.error('Preview generation error:', error);
            this.showToast('Failed to generate preview. Please try again.', 'error');
        } finally {
            this.restorePreviewButton();
        }
    }
    
    collectFormData() {
        // Get the Quill instance - try multiple approaches
        let quillInstance = null;
        let contentText = '';
        let contentHtml = '';
        
        // Method 1: Try to get from the form manager
        if (this.formManager && this.formManager.quill) {
            quillInstance = this.formManager.quill;
            console.log('Got Quill from form manager');
        }
        
        // Method 2: Try to find Quill instance globally
        if (!quillInstance && window.Quill) {
            // Look for any Quill instance on the page
            const quillContainer = document.querySelector('#contentEditor .ql-editor');
            if (quillContainer) {
                // Try to find the Quill instance
                const quillElement = document.querySelector('#contentEditor');
                if (quillElement && quillElement.__quill) {
                    quillInstance = quillElement.__quill;
                    console.log('Got Quill from element __quill property');
                }
            }
        }
        
        // Method 3: Try to get content directly from the editor
        if (!quillInstance) {
            const editorElement = document.querySelector('#contentEditor .ql-editor');
            if (editorElement) {
                contentHtml = editorElement.innerHTML;
                contentText = editorElement.textContent || editorElement.innerText;
                console.log('Got content directly from editor element');
            }
        } else {
            contentHtml = quillInstance.root.innerHTML;
            contentText = quillInstance.getText();
            console.log('Got content from Quill instance');
        }
        
        // Method 4: Fallback to hidden content input
        if (!contentText || contentText.trim().length === 0) {
            const contentInput = document.getElementById('content');
            if (contentInput && contentInput.value) {
                contentHtml = contentInput.value;
                // Strip HTML to get text content for word count
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contentHtml;
                contentText = tempDiv.textContent || tempDiv.innerText || '';
                console.log('Got content from hidden input');
            }
        }
        
        console.log('Content text length:', contentText.length);
        console.log('Content preview:', contentText.substring(0, 100) + '...');
        
        return {
            title: document.getElementById('title')?.value?.trim() || '',
            service: this.getSelectedServiceName(),
            excerpt: document.getElementById('excerpt')?.value?.trim() || '',
            content: contentHtml,
            contentText: contentText,
            featured: document.getElementById('featured')?.value === '1',
            wordCount: this.calculateWordCount(contentText),
            image: this.getImagePreview(),
            date: new Date().toLocaleDateString()
        };
    }
    
    getSelectedServiceName() {
        const serviceSelect = document.getElementById('service_id');
        if (serviceSelect && serviceSelect.value) {
            const selectedOption = serviceSelect.querySelector(`option[value="${serviceSelect.value}"]`);
            return selectedOption ? selectedOption.textContent : 'Unknown Service';
        }
        return 'No Service Selected';
    }
    
    calculateWordCount(text) {
        if (!text || typeof text !== 'string') {
            // Fallback to manual word count if provided
            const manualCount = document.getElementById('word_count_manual')?.value;
            if (manualCount && !isNaN(parseInt(manualCount))) {
                return parseInt(manualCount);
            }
            return 0;
        }
        
        const cleanText = text.trim();
        if (!cleanText) return 0;
        
        // Split by whitespace and filter out empty strings
        const words = cleanText.split(/\s+/).filter(word => word.length > 0);
        return words.length;
    }
    
    getImagePreview() {
        const imageInput = document.getElementById('image');
        const existingPreview = document.getElementById('imagePreview');
        
        if (existingPreview && existingPreview.src && existingPreview.style.display !== 'none') {
            return existingPreview.src;
        }
        
        if (imageInput && imageInput.files && imageInput.files[0]) {
            return URL.createObjectURL(imageInput.files[0]);
        }
        
        return null;
    }
    
    validateForPreview(formData) {
        const issues = [];
        
        if (!formData.title || formData.title.length < 3) {
            issues.push('Title is required and must be at least 3 characters long');
        }
        
        if (!formData.service || formData.service === 'No Service Selected') {
            issues.push('Please select a service category');
        }
        
        // More lenient content validation
        const contentLength = formData.contentText ? formData.contentText.trim().length : 0;
        console.log('Content validation - length:', contentLength);
        
        if (contentLength < 10) {
            issues.push(`Content is too short for meaningful preview (${contentLength} characters, minimum 10 required)`);
        }
        
        if (issues.length > 0) {
            console.log('Validation issues:', issues);
            this.showToast(issues.join('. '), 'warning');
            return false;
        }
        
        return true;
    }
    
    updatePreviewContent(formData) {
        // Update title
        const titleEl = document.getElementById('previewTitle');
        if (titleEl) {
            titleEl.textContent = formData.title || 'Untitled Sample';
        }
        
        // Update service badge
        const serviceEl = document.getElementById('previewService');
        if (serviceEl) {
            serviceEl.textContent = formData.service;
        }
        
        // Update featured badge
        const featuredEl = document.getElementById('previewFeatured');
        if (featuredEl) {
            featuredEl.style.display = formData.featured ? 'inline-flex' : 'none';
        }
        
        // Update word count
        const wordCountEl = document.getElementById('previewWordCount');
        if (wordCountEl) {
            wordCountEl.textContent = formData.wordCount.toLocaleString();
        }
        
        // Update date
        const dateEl = document.getElementById('previewDate');
        if (dateEl) {
            dateEl.textContent = formData.date;
        }
        
        // Update excerpt
        const excerptEl = document.getElementById('previewExcerpt');
        if (excerptEl) {
            excerptEl.textContent = formData.excerpt || 'No excerpt provided.';
        }
        
        // Update content
        const contentEl = document.getElementById('previewContent');
        if (contentEl) {
            if (formData.content && formData.content.trim()) {
                contentEl.innerHTML = formData.content;
            } else {
                contentEl.innerHTML = '<p class="text-muted"><em>No content provided.</em></p>';
            }
        }
        
        // Update image
        const imageEl = document.getElementById('previewImage');
        const noImageEl = document.querySelector('.preview-no-image');
        
        if (formData.image) {
            if (imageEl) {
                imageEl.src = formData.image;
                imageEl.style.display = 'block';
            }
            if (noImageEl) {
                noImageEl.style.display = 'none';
            }
        } else {
            if (imageEl) {
                imageEl.style.display = 'none';
            }
            if (noImageEl) {
                noImageEl.style.display = 'flex';
            }
        }
    }
    
    saveFromPreview() {
        // Hide the preview modal
        this.modal.hide();
        
        // Trigger the original form submission
        setTimeout(() => {
            const originalSubmitBtn = document.querySelector('.action-buttons .btn-primary:not(#previewSaveBtn)');
            if (originalSubmitBtn) {
                originalSubmitBtn.click();
            } else {
                // Fallback to form submission
                const form = document.getElementById('sampleForm');
                if (form) {
                    form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                }
            }
        }, 300);
    }
    
    restorePreviewButton() {
        if (this.previewBtn) {
            this.previewBtn.classList.remove('loading');
            this.previewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Preview Sample';
        }
    }
    
    showToast(message, type = 'info') {
        // Use existing toast functionality if available
        if (window.sampleFormManager && typeof window.sampleFormManager.showToast === 'function') {
            window.sampleFormManager.showToast(message, type);
            return;
        }
        
        // Fallback toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
}

// Modified initialization to make the form manager globally accessible
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the main form manager first and make it globally accessible
    window.sampleFormManager = new SampleFormManager();
    
    // Wait a bit then initialize preview manager
    setTimeout(() => {
        window.samplePreviewManager = new SamplePreviewManager();
    }, 300);
});

// Make classes globally accessible for integration
window.SamplePreviewManager = SamplePreviewManager;
</script>
{% endblock %}

