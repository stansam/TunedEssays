{% extends "admin/base.html" %}

{% block title %}Payment Details - {{ payment.payment_id }} | TunedEssays Admin{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .payment-header {
        background-color: var(--primary-subtle);
        border-left: 4px solid var(--primary);
        padding: 1.5rem;
        border-radius: 10px;
    }
    
    .timeline {
        position: relative;
        padding-left: 2.5rem;
    }
    
    .timeline::before {
        content: "";
        position: absolute;
        left: 0.75rem;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: var(--gray-light);
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-marker {
        position: absolute;
        left: -2.5rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: var(--primary);
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--primary-light);
    }
    
    .timeline-marker.completed {
        background-color: var(--success);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
    }
    
    .timeline-marker.pending {
        background-color: var(--warning);
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3);
    }
    
    .timeline-marker.failed {
        background-color: var(--danger);
        box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.3);
    }
    
    .timeline-marker.refunded {
        background-color: var(--info);
        box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.3);
    }
    
    .status-badge {
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 700;
        text-transform: uppercase;
        border-radius: 50rem;
    }
    
    .badge-pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #856404;
    }
    
    .badge-completed {
        background-color: rgba(76, 175, 80, 0.2);
        color: #155724;
    }
    
    .badge-failed {
        background-color: rgba(244, 67, 54, 0.2);
        color: #721c24;
    }
    
    .badge-refunded {
        background-color: rgba(0, 188, 212, 0.2);
        color: #0c5460;
    }
    
    .payment-details-card {
        transition: all 0.3s ease;
    }
    
    .payment-details-card:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transform: translateY(-2px);
    }
    
    .payment-method-icon {
        font-size: 2rem;
        margin-right: 0.5rem;
    }
    
    .action-btns .btn {
        transition: all 0.2s;
    }
    
    .action-btns .btn:hover {
        transform: translateY(-2px);
    }
    
    .processor-response {
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 1rem;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    .refund-card {
        border-left: 3px solid var(--info);
    }
    
    .transaction-item:not(:last-child) {
        border-bottom: 1px solid var(--gray-light);
    }
    
    /* Button spinner */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }
    
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* JSON formatter */
    .json-key {
        color: #ff5722;
    }
    
    .json-value {
        color: #2196f3;
    }
    
    .json-string {
        color: #4caf50;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin.list_payments') }}">Payments</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ payment.payment_id }}</li>
        </ol>
    </nav>

    <!-- Alert for status -->
    <div class="alert alert-{{ 'success' if payment.status == 'completed' else 'warning' if payment.status == 'pending' else 'danger' if payment.status == 'failed' else 'info' }} d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-{{ 'check-circle' if payment.status == 'completed' else 'clock' if payment.status == 'pending' else 'exclamation-circle' if payment.status == 'failed' else 'info-circle' }} me-2"></i>
        <div>
            This payment is currently <strong>{{ payment.status }}</strong>
            {% if payment.status == 'pending' %}
            - Awaiting confirmation from payment processor.
            {% elif payment.status == 'completed' %}
            - Successfully processed on {{ payment.updated_at.strftime('%B %d, %Y at %H:%M') }}.
            {% elif payment.status == 'failed' %}
            - Payment processing failed. Please check processor response for details.
            {% elif payment.status == 'refunded' %}
            - This payment has been refunded.
            {% endif %}
        </div>
    </div>

    <!-- Top Actions Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Payment Details</h1>
            <p class="text-muted">Full information for payment ID {{ payment.payment_id }}</p>
        </div>
        <div class="action-btns">
            {% if payment.status == 'pending' %}
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#confirmPaymentModal">
                <i class="fas fa-check me-1"></i> Mark as Completed
            </button>
            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#failPaymentModal">
                <i class="fas fa-times me-1"></i> Mark as Failed
            </button>
            {% elif payment.status == 'completed' %}
            <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#refundModal">
                <i class="fas fa-undo me-1"></i> Process Refund
            </button>
            <a href="{{ url_for('admin.view_invoice', invoice_id=payment.invoice.id) if payment.invoice else '#' }}" class="btn btn-secondary me-2 {{ 'disabled' if not payment.invoice else '' }}">
                <i class="fas fa-file-invoice me-1"></i> View Invoice
            </a>
            {% endif %}
            <a href="{{ url_for('admin.view_order', order_id=payment.order_id) }}" class="btn btn-primary">
                <i class="fas fa-file-alt me-1"></i> View Order
            </a>
        </div>
    </div>

    <!-- Payment Information -->
    <div class="row">
        <!-- Payment Summary -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm payment-details-card h-100">
                <div class="card-header payment-header bg-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0">Payment Summary</h5>
                        <span class="status-badge badge-{{ payment.status }}">{{ payment.status }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <p class="mb-1 text-muted small">Payment ID</p>
                            <p class="mb-0 fw-bold">{{ payment.payment_id }}</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1 text-muted small">Order ID</p>
                            <p class="mb-0 fw-bold">
                                <a href="{{ url_for('admin.view_order', order_id=payment.order_id) }}" class="text-decoration-none">
                                    {{ payment.order.order_number if payment.order.order_number else payment.order_id }}
                                </a>
                            </p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1 text-muted small">Amount</p>
                            <p class="mb-0 fw-bold fs-4 text-primary">${{ "%.2f"|format(payment.amount) }}</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1 text-muted small">Date</p>
                            <p class="mb-0">{{ payment.created_at.strftime('%b %d, %Y') }}</p>
                        </div>
                        <div class="col-12">
                            <p class="mb-1 text-muted small">Payment Method</p>
                            <div class="d-flex align-items-center">
                                <div class="payment-method-icon">
                                    {% if payment.method == 'credit_card' %}
                                        <i class="fas fa-credit-card text-primary"></i>
                                    {% elif payment.method == 'paypal' %}
                                        <i class="fab fa-paypal text-info"></i>
                                    {% elif payment.method == 'apple_pay' %}
                                        <i class="fab fa-apple-pay text-dark"></i>
                                    {% elif payment.method == 'google_pay' %}
                                        <i class="fab fa-google-pay text-success"></i>
                                    {% else %}
                                        <i class="fas fa-money-bill-wave text-success"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="mb-0 fw-bold">
                                        {{ {
                                            'credit_card': 'Credit Card',
                                            'paypal': 'PayPal',
                                            'apple_pay': 'Apple Pay',
                                            'google_pay': 'Google Pay'
                                        }.get(payment.method, payment.method|title) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <p class="mb-1 text-muted small">Customer</p>
                            <p class="mb-0">
                                <a href="{{ url_for('admin.view_user', user_id=payment.user_id) }}" class="text-decoration-none">
                                    {{ payment.user.get_name() }} 
                                </a>
                                <span class="text-muted">({{ payment.user.email }})</span>
                            </p>
                        </div>
                        {% if payment.processor_id %}
                        <div class="col-12">
                            <p class="mb-1 text-muted small">Processor ID</p>
                            <p class="mb-0 font-monospace">{{ payment.processor_id }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Last Updated: {{ payment.updated_at.strftime('%b %d, %Y %H:%M:%S') }}</span>
                        <a href="#" class="btn btn-sm btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> Print
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Information -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm payment-details-card h-100">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="paymentDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="true">
                                Transactions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="refunds-tab" data-bs-toggle="tab" data-bs-target="#refunds" type="button" role="tab" aria-controls="refunds" aria-selected="false">
                                Refunds <span class="badge text-bg-secondary">{{ refunds|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="false">
                                Timeline
                            </button>
                        </li>
                        {% if payment.processor_response %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="response-tab" data-bs-toggle="tab" data-bs-target="#response" type="button" role="tab" aria-controls="response" aria-selected="false">
                                Processor Response
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content" id="paymentDetailsTabsContent">
                        <!-- Transactions Tab -->
                        <div class="tab-pane fade show active" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
                            {% if payment.transactions %}
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in payment.transactions %}
                                        <tr class="transaction-item">
                                            <td class="font-monospace">{{ transaction.transaction_id }}</td>
                                            <td>
                                                <span class="badge rounded-pill 
                                                    {{ 'bg-primary' if transaction.type == 'payment' else 
                                                       'bg-info' if transaction.type == 'refund' else 
                                                       'bg-warning' }}">
                                                    {{ transaction.type|title }}
                                                </span>
                                            </td>
                                            <td>${{ "%.2f"|format(transaction.amount) }}</td>
                                            <td>
                                                <span class="badge rounded-pill
                                                    {{ 'bg-success' if transaction.status == 'success' else
                                                       'bg-warning' if transaction.status == 'pending' else
                                                       'bg-danger' }}">
                                                    {{ transaction.status|title }}
                                                </span>
                                            </td>
                                            <td>{{ transaction.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-secondary" title="View Details" 
                                                        data-bs-toggle="modal" data-bs-target="#transactionModal{{ transaction.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        
                                        <!-- Transaction Detail Modal -->
                                        <div class="modal fade" id="transactionModal{{ transaction.id }}" tabindex="-1" aria-labelledby="transactionModalLabel{{ transaction.id }}" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="transactionModalLabel{{ transaction.id }}">Transaction Details</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="row g-3">
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Transaction ID</p>
                                                                <p class="mb-0 font-monospace">{{ transaction.transaction_id }}</p>
                                                            </div>
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Date</p>
                                                                <p class="mb-0">{{ transaction.created_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                                            </div>
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Type</p>
                                                                <p class="mb-0">{{ transaction.type|title }}</p>
                                                            </div>
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Amount</p>
                                                                <p class="mb-0 fw-bold">${{ "%.2f"|format(transaction.amount) }}</p>
                                                            </div>
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Status</p>
                                                                <p class="mb-0">{{ transaction.status|title }}</p>
                                                            </div>
                                                            <div class="col-6">
                                                                <p class="mb-1 text-muted small">Processor ID</p>
                                                                <p class="mb-0 font-monospace">{{ transaction.processor_id }}</p>
                                                            </div>
                                                            {% if transaction.processor_response %}
                                                            <div class="col-12">
                                                                <p class="mb-1 text-muted small">Processor Response</p>
                                                                <div class="processor-response">
                                                                    <pre id="jsonResponse{{ transaction.id }}">{{ transaction.processor_response }}</pre>
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-exchange-alt text-muted" style="font-size: 3rem;"></i>
                                </div>
                                <h5>No Transactions Found</h5>
                                <p class="text-muted">This payment doesn't have any transaction records yet.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Refunds Tab -->
                        <div class="tab-pane fade" id="refunds" role="tabpanel" aria-labelledby="refunds-tab">
                            {% if refunds %}
                            <div class="row g-3">
                                {% for refund in refunds %}
                                <div class="col-md-6">
                                    <div class="card refund-card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h6 class="card-title mb-0">Refund #{{ refund.id }}</h6>
                                                <span class="badge {{ 'bg-warning' if refund.status == 'pending' else 'bg-success' if refund.status == 'processed' else 'bg-danger' }}">
                                                    {{ refund.status|title }}
                                                </span>
                                            </div>
                                            <div class="row g-2 mb-3">
                                                <div class="col-6">
                                                    <p class="mb-1 text-muted small">Amount</p>
                                                    <p class="mb-0 fw-bold">${{ "%.2f"|format(refund.amount) }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <p class="mb-1 text-muted small">Date</p>
                                                    <p class="mb-0">{{ refund.created_at.strftime('%b %d, %Y') }}</p>
                                                </div>
                                                {% if refund.refund_date %}
                                                <div class="col-12">
                                                    <p class="mb-1 text-muted small">Processed Date</p>
                                                    <p class="mb-0">{{ refund.refund_date.strftime('%b %d, %Y %H:%M') }}</p>
                                                </div>
                                                {% endif %}
                                                {% if refund.processed_by %}
                                                <div class="col-12">
                                                    <p class="mb-1 text-muted small">Processed By</p>
                                                    <p class="mb-0">{{ refund.admin.get_name() }}</p>
                                                </div>
                                                {% endif %}
                                                {% if refund.reason %}
                                                <div class="col-12">
                                                    <p class="mb-1 text-muted small">Reason</p>
                                                    <p class="mb-0 text-truncate-2">{{ refund.reason }}</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% if refund.status == 'pending' %}
                                            <div class="d-flex gap-2 mt-2">
                                                <button class="btn btn-sm btn-success" onclick="approveRefund({{ refund.id }})">
                                                    <i class="fas fa-check me-1"></i> Approve
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="denyRefund({{ refund.id }})">
                                                    <i class="fas fa-times me-1"></i> Deny
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-undo text-muted" style="font-size: 3rem;"></i>
                                </div>
                                <h5>No Refunds</h5>
                                <p class="text-muted">This payment doesn't have any refund requests or processed refunds.</p>
                                {% if payment.status == 'completed' %}
                                <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#refundModal">
                                    <i class="fas fa-plus me-1"></i> Create Refund
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Timeline Tab -->
                        <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Payment Created</h6>
                                        <p class="mb-0 text-muted">{{ payment.created_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">Payment of ${{ "%.2f"|format(payment.amount) }} was initiated via {{ payment.method|replace('_', ' ')|title }}.</p>
                                    </div>
                                </div>
                                
                                {% for transaction in payment.transactions|sort(attribute='created_at') %}
                                <div class="timeline-item">
                                    <div class="timeline-marker {{ 'completed' if transaction.status == 'success' else 'pending' if transaction.status == 'pending' else 'failed' }}"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">{{ transaction.type|title }} {{ transaction.status|title }}</h6>
                                        <p class="mb-0 text-muted">{{ transaction.created_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">
                                            {{ transaction.type|title }} of ${{ "%.2f"|format(transaction.amount) }} was {{ transaction.status }}.
                                            {% if transaction.processor_id %}
                                            <span class="text-muted">(Processor ID: {{ transaction.processor_id }})</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if payment.status == 'completed' and payment.updated_at != payment.created_at %}
                                <div class="timeline-item">
                                    <div class="timeline-marker completed"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Payment Completed</h6>
                                        <p class="mb-0 text-muted">{{ payment.updated_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">Payment was successfully processed.</p>
                                    </div>
                                </div>
                                {% elif payment.status == 'failed' and payment.updated_at != payment.created_at %}
                                <div class="timeline-item">
                                    <div class="timeline-marker failed"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Payment Failed</h6>
                                        <p class="mb-0 text-muted">{{ payment.updated_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">Payment processing failed.</p>
                                    </div>
                                </div>
                                {% elif payment.status == 'refunded' and payment.updated_at != payment.created_at %}
                                <div class="timeline-item">
                                    <div class="timeline-marker refunded"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Payment Refunded</h6>
                                        <p class="mb-0 text-muted">{{ payment.updated_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">Payment has been refunded.</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% for refund in refunds|sort(attribute='created_at') %}
                                <div class="timeline-item">
                                    <div class="timeline-marker {{ 'completed' if refund.status == 'processed' else 'pending' if refund.status == 'pending' else 'failed' }}"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Refund {{ refund.status|title }}</h6>
                                        <p class="mb-0 text-muted">{{ refund.created_at.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">
                                            Refund request for ${{ "%.2f"|format(refund.amount) }} was created.
                                            {% if refund.reason %}
                                            <br><span class="text-muted">Reason: "{{ refund.reason }}"</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                
                                {% if refund.status == 'processed' and refund.refund_date %}
                                <div class="timeline-item">
                                    <div class="timeline-marker completed"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Refund Processed</h6>
                                        <p class="mb-0 text-muted">{{ refund.refund_date.strftime('%b %d, %Y %H:%M:%S') }}</p>
                                        <p class="mb-0">
                                            Refund of ${{ "%.2f"|format(refund.amount) }} was processed successfully.
                                            {% if refund.processed_by %}
                                            <br><span class="text-muted">Processed by: {{ refund.admin.get_name() }}</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Processor Response Tab -->
                        {% if payment.processor_response %}
                        <div class="tab-pane fade" id="response" role="tabpanel" aria-labelledby="response-tab">
                            <h6 class="mb-3">Raw Processor Response</h6>
                            <div class="processor-response">
                                <pre id="jsonProcessorResponse">{{ payment.processor_response }}</pre>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information Section -->
    <div class="row">
        <!-- Order Items -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm payment-details-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Order Items</h5>
                </div>
                <div class="card-body">
                    {% if payment.order and payment.order.items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in payment.order.items %}
                                <tr>
                                    <td>
                                        {% if item.service_id %}
                                        <a href="{{ url_for('admin.view_service', service_id=item.service_id) }}" class="text-decoration-none">
                                            {{ item.title }}
                                        </a>
                                        {% else %}
                                        {{ item.title }}
                                        {% endif %}
                                    </td>
                                    <td>{{ item.type|replace('_', ' ')|title }}</td>
                                    <td>${{ "%.2f"|format(item.price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">Subtotal</td>
                                    <td>${{ "%.2f"|format(payment.order.subtotal) }}</td>
                                </tr>
                                {% if payment.order.discount_amount %}
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">Discount</td>
                                    <td>-${{ "%.2f"|format(payment.order.discount_amount) }}</td>
                                </tr>
                                {% endif %}
                                {% if payment.order.tax_amount %}
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">Tax</td>
                                    <td>${{ "%.2f"|format(payment.order.tax_amount) }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">Total</td>
                                    <td class="fw-bold">${{ "%.2f"|format(payment.order.total) }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-shopping-cart text-muted" style="font-size: 3rem;"></i>
                        </div>
                        <h5>No Order Items Found</h5>
                        <p class="text-muted">This payment is not associated with any order items.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Billing Address -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm payment-details-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Billing Information</h5>
                </div>
                <div class="card-body">
                    {% if payment.billing_address %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <p class="mb-1 text-muted small">Name</p>
                            <p class="mb-0">{{ payment.billing_address.first_name }} {{ payment.billing_address.last_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1 text-muted small">Email</p>
                            <p class="mb-0">{{ payment.user.email }}</p>
                        </div>
                        {% if payment.billing_address.phone %}
                        <div class="col-md-6">
                            <p class="mb-1 text-muted small">Phone</p>
                            <p class="mb-0">{{ payment.billing_address.phone }}</p>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <p class="mb-1 text-muted small">Address</p>
                            <p class="mb-0">
                                {{ payment.billing_address.street_address }}, 
                                {% if payment.billing_address.street_address2 %}
                                {{ payment.billing_address.street_address2 }}, 
                                {% endif %}
                                {{ payment.billing_address.city }}, 
                                {{ payment.billing_address.state }} {{ payment.billing_address.zip_code }},
                                {{ payment.billing_address.country }}
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-map-marker-alt text-muted" style="font-size: 3rem;"></i>
                        </div>
                        <h5>No Billing Address</h5>
                        <p class="text-muted">No billing address was provided for this payment.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Confirm Payment Modal -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">Mark Payment as Completed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.complete_payment', payment_id=payment.payment_id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to mark this payment as completed? This action should only be taken if the payment has been verified with the payment processor.
                    </div>
                    <div class="mb-3">
                        <label for="processorId" class="form-label">Processor ID (Optional)</label>
                        <input type="text" class="form-control" id="processorId" name="processor_id" placeholder="Enter processor transaction ID">
                    </div>
                    <div class="mb-3">
                        <label for="processorResponse" class="form-label">Processor Response (Optional)</label>
                        <textarea class="form-control" id="processorResponse" name="processor_response" rows="3" placeholder="Enter processor response data (JSON format preferred)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i> Confirm Completion
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Failure Payment Modal -->
<div class="modal fade" id="failPaymentModal" tabindex="-1" aria-labelledby="failPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="failPaymentModalLabel">Mark Payment as Failed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.fail_payment', payment_id=payment.payment_id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Are you sure you want to mark this payment as failed? This will cancel the corresponding order.
                    </div>
                    <div class="mb-3">
                        <label for="failureReason" class="form-label">Failure Reason</label>
                        <input type="text" class="form-control" id="failureReason" name="failure_reason" placeholder="Enter reason for failure" required>
                    </div>
                    <div class="mb-3">
                        <label for="failureResponse" class="form-label">Processor Response (Optional)</label>
                        <textarea class="form-control" id="failureResponse" name="processor_response" rows="3" placeholder="Enter processor response data (JSON format preferred)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i> Mark as Failed
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refundModalLabel">Process Refund</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.process_refund', payment_id=payment.payment_id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        Please provide details for processing a refund for this payment.
                    </div>
                    <div class="mb-3">
                        <label for="refundAmount" class="form-label">Refund Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="refundAmount" name="amount" min="0.01" max="{{ payment.amount }}" step="0.01" value="{{ payment.amount }}" required>
                        </div>
                        <div class="form-text">Maximum refund amount: ${{ "%.2f"|format(payment.amount) }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="refundReason" class="form-label">Reason for Refund</label>
                        <select class="form-select" id="refundReason" name="reason_type">
                            <option value="customer_request">Customer Request</option>
                            <option value="duplicate_payment">Duplicate Payment</option>
                            <option value="fraudulent">Fraudulent Transaction</option>
                            <option value="service_unavailable">Service Unavailable</option>
                            <option value="quality_issue">Quality Issue</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="refundNotes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="refundNotes" name="notes" rows="3" placeholder="Enter any additional notes about this refund"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notifyCustomer" name="notify_customer" checked>
                        <label class="form-check-label" for="notifyCustomer">
                            Notify customer via email
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-undo me-1"></i> Process Refund
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // Initialize Select2
    $(document).ready(function() {
        $('.select2').select2();
        
        // Format JSON responses
        function formatJSON(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                try {
                    const jsonObj = JSON.parse(element.textContent);
                    const formattedJSON = JSON.stringify(jsonObj, null, 2);
                    element.innerHTML = formattedJSON
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                            let cls = 'json-value';
                            if (/^"/.test(match)) {
                                if (/:$/.test(match)) {
                                    cls = 'json-key';
                                } else {
                                    cls = 'json-string';
                                }
                            }
                            return '<span class="' + cls + '">' + match + '</span>';
                        });
                } catch (e) {
                    console.log("Error parsing JSON:", e);
                }
            }
        }
        
        // Format all JSON responses
        formatJSON('jsonProcessorResponse');
        {% for transaction in payment.transactions %}
            formatJSON('jsonResponse{{ transaction.id }}');
        {% endfor %}
    });
    
    // Functions for refund actions
    function approveRefund(refundId) {
        if (confirm('Are you sure you want to approve this refund?')) {
            window.location.href = "{{ url_for('admin.approve_refund', payment_id=payment.payment_id) }}/" + refundId;
        }
    }
    
    function denyRefund(refundId) {
        if (confirm('Are you sure you want to deny this refund?')) {
            window.location.href = "{{ url_for('admin.deny_refund', payment_id=payment.payment_id) }}/" + refundId;
        }
    }
</script>
{% endblock %}